<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
    }
</style>

<body>

    <div>

        <h2>plant code {{plant.plant_name}}</h2>
        <p class="plant-code" value="{{plant.plant_code}}">plant name {{plant.plant_code}}</p>
        <p>description {{plant.description}}</p>
        

        <button class="config-btn" data-plant="{{plant.id}}">
            Configure Pin
        </button>
        <h2>{{ plant.plant_name }}</h2>

        <input type="file" name="plant-image" id="plant-image" accept="image/*">
        <img src="" alt="" id="image-preview" style="width: 150px;">

        {% set assigned_pins = reserved_pins | selectattr("plant_id", "equalto", plant.id|string) | map(attribute="sensor_pin") | list %}

        {% if assigned_pins %}
            {% for pin in assigned_pins %}
                <p>Assigned Pin: {{ pin }}</p>
                <button data-pin="{{ pin }}" class="release-pin">Release Pin</button>
                <input type="text" name="plant-id" class="plant-id" value="{{plant.id}}" hidden>
        {% endfor %} 
        {% else %}
            <p>No pin assigned</p>
        {% endif %}

        <div class="modal">
            <select name="select-pin" class="select-pin"></select>
            <input type="text" name="sensor-name" class="sensor-name" placeholder="e.g., Tomato Sensor">
            <button class="set-pin-btn">Set Pin</button>      
        </div>


    </div>


<script>

document.addEventListener("DOMContentLoaded", async () => {

    const modal = document.querySelector(".modal");
    const setPinButton = modal.querySelector(".set-pin-btn");
    const configureButtons = document.querySelectorAll(".config-btn");
    const releasePin = document.querySelectorAll(".release-pin");
    const select = modal.querySelector(".select-pin");
    const plantImage = document.querySelector("#plant-image");
    const imagePreview = document.querySelector("#image-preview")

    let selectedImage = null;
    let currentPlant = null;

    configureButtons.forEach((button) => {
        button.addEventListener('click', () => openModal(button.dataset.plant));
    });

    async function openModal (plantCode) {
        modal.style.display = "flex";
        currentPlant = plantCode;
        select.innerHTML = "";

        try {
            const response = await fetch("http://127.0.0.1:5000/user/fetch_pins");
            const data = await response.json();

            data.available_pins.forEach((pin) => {
                const option = document.createElement("option");
                option.value = pin;
                option.textContent = pin;
                select.appendChild(option);
            });

        } catch (Error) {
            console.log(Error);
        }
    };


    setPinButton.addEventListener('click', async () => {
        const pin = select.value;
        const sensorName = document.querySelector(".sensor-name").value;

        const formData = new FormData()
        formData.append("pin", pin)
        formData.append("currentPlant", currentPlant)
        formData.append("sensorName", sensorName)
        formData.append("image", selectedImage)

        try {
            const response = await fetch("http://127.0.0.1:5000/user/set_pin_process", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            console.log(data);

        } catch (Error) {
            console.log(Error);
        }
    });

    releasePin.forEach((button) => {
        button.addEventListener('click', async () => {
            const pin = button.dataset.pin;
            const plantContainer = button.closest("div");
            const plantId = plantContainer.querySelector(".plant-id").value;
            console.log(plantId)
            try {
                const response = await fetch("http://127.0.0.1:5000/user/release_pin", {
                    method: "POST",
                    headers: {"Content-Type" : "application/json"},
                    body: JSON.stringify({plantId, pin})
                });
                const data = await response.json();

                if (data.status) {
                    button.previousElementSibling.remove();
                    button.remove()
                }

            } catch (Error) {
                console.log(Error);
            }
        });
    });

    plantImage.addEventListener('change', imageChange)

    function imageChange() {
        const image = plantImage.files[0];
        
        if (image) {
            selectedImage = image
            imagePreview.src = URL.createObjectURL(image);
        }
    }

});

</script>

</body>
</html>
